<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melaka: The Golden Port | Kesultanan Melayu Melaka</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&family=Playfair+Display:ital,wght@0,700;1,700;1,900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #ffd700;
            --primary-glow: rgba(255, 215, 0, 0.4);
            --bg-dark: #050a0f;
            --surface: rgba(0, 0, 0, 0.75);
            --accent-red: #ff4757;
            --accent-blue: #70a1ff;
            --accent-green: #2ed573;
            --text-main: #f1f2f6;
            --font-ui: 'Outfit', sans-serif;
            --font-serif: 'Playfair Display', serif;
            --transition-smooth: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-ui);
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #main-canvas-wrapper {
            position: fixed;
            inset: 0;
            z-index: 0;
        }

        #bg-canvas,
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* --- UI LAYER REWORKED FOR ALIGNMENT --- */
        #ui-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding: 30px;
        }

        .hud-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }

        .hud-row.bottom {
            margin-top: auto;
            align-items: flex-end;
        }

        /* --- STAT BOXES --- */
        .stat-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: auto;
        }

        .stat-card {
            background: var(--surface);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.25);
            padding: 15px 30px;
            border-radius: 12px;
            min-width: 160px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .stat-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
        }

        .stat-label {
            display: block;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 2px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-value {
            font-family: var(--font-serif);
            font-size: 2.2rem;
            font-weight: 900;
            color: #fff;
            line-height: 1;
        }

        /* --- CENTER HUD (ERA & PROGRESS) --- */
        .center-hud {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        #current-era-name {
            font-family: var(--font-serif);
            font-style: italic;
            font-size: 1.6rem;
            color: var(--primary);
            text-shadow: 0 0 20px var(--primary-glow);
            text-align: center;
        }

        .progress-container {
            width: 350px;
            height: 10px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffd700, #ff4d4d);
            transition: width 0.5s ease;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        /* --- LANGUAGE TOGGLE (CLEAN ALIGNMENT) --- */
        #lang-swap {
            background: var(--surface);
            color: #fff;
            border: 1px solid var(--primary);
            padding: 8px 18px;
            border-radius: 8px;
            font-weight: 900;
            font-size: 0.8rem;
            letter-spacing: 1px;
            cursor: pointer;
            pointer-events: auto;
            transition: var(--transition-smooth);
            text-transform: uppercase;
            margin-bottom: 10px;
            align-self: flex-end;
        }

        #lang-swap:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        /* --- COMBO BAR --- */
        .combo-meter {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            margin-top: 8px;
            border-radius: 2px;
            overflow: hidden;
        }

        #combo-fill {
            height: 100%;
            width: 0%;
            background: var(--primary);
            transition: width 0.1s linear;
        }

        /* --- SCREENS --- */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(5, 10, 15, 0.98);
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }

        .overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 215, 0, 0.2);
            padding: 60px;
            border-radius: 30px;
            text-align: center;
            max-width: 800px;
            width: 90%;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.6);
        }

        h1 {
            font-family: var(--font-serif);
            font-size: 4.5rem;
            line-height: 1;
            margin-bottom: 15px;
            background: linear-gradient(to bottom, #fff 40%, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-main {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 20px 60px;
            font-size: 1.5rem;
            font-weight: 900;
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 4px;
            transition: var(--transition-smooth);
            margin-top: 30px;
        }

        .btn-main:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 15px 45px var(--primary-glow);
        }

        /* --- TOASTS & CHIPS --- */
        .toast-area {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 15;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .fact-chip {
            background: var(--surface);
            border: 1px solid var(--primary);
            padding: 12px 25px;
            border-radius: 50px;
            color: #fff;
            font-size: 0.95rem;
            animation: chipFadeIn 0.5s cubic-bezier(0.19, 1, 0.22, 1) forwards;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        @keyframes chipFadeIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* --- WORLD TEXT --- */
        .float-text {
            position: absolute;
            pointer-events: none;
            font-weight: 900;
            font-size: 1.8rem;
            font-family: var(--font-serif);
            animation: textRise 1.2s forwards;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
        }

        @keyframes textRise {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-120px);
                opacity: 0;
            }
        }

        /* --- REWARD STARS --- */
        .stars {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .star {
            font-size: 4rem;
            color: rgba(255, 255, 255, 0.05);
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .star.won {
            color: var(--primary);
            text-shadow: 0 0 30px var(--primary-glow);
            transform: scale(1.2) rotate(10deg);
        }
    </style>
</head>

<body>

    <div id="main-canvas-wrapper">
        <canvas id="bg-canvas"></canvas>
        <canvas id="game-canvas"></canvas>
    </div>

    <!-- UI OVERLAY -->
    <div id="ui-overlay">
        <!-- TOP HUD -->
        <div class="hud-row">
            <div class="stat-group">
                <div class="stat-card">
                    <span class="stat-label" data-i18n="score">Wealth</span>
                    <span id="score-val" class="stat-value">0</span>
                    <div class="combo-meter">
                        <div id="combo-fill"></div>
                    </div>
                </div>
            </div>

            <div class="center-hud">
                <div id="current-era-name" data-i18n="era_1">The Founding - 1400</div>
                <div class="progress-container">
                    <div id="progress-fill"></div>
                </div>
            </div>

            <div class="stat-group">
                <button id="lang-swap">BM / EN</button>
                <div class="stat-card">
                    <span class="stat-label" data-i18n="timer">Timeline</span>
                    <span id="time-val" class="stat-value">120</span>
                </div>
            </div>
        </div>

        <!-- BOTTOM HUD -->
        <div class="hud-row bottom">
            <div class="stat-group">
                <div class="stat-card">
                    <span class="stat-label" data-i18n="glory">Imperial Glory</span>
                    <span id="glory-val" class="stat-value">1000</span>
                </div>
            </div>

            <!-- Facts Toast -->
            <div id="toast-bin" class="toast-area"></div>

            <div class="stat-group">
                <div class="stat-card">
                    <span class="stat-label" data-i18n="top">Record High</span>
                    <span id="top-val" class="stat-value">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- INITIAL SCREEN -->
    <div id="start-screen" class="overlay">
        <div class="card">
            <h1 data-i18n="title">Melaka Empire</h1>
            <p style="color: #bbb; max-width: 600px; margin: 0 auto 30px; font-size: 1.1rem;" data-i18n="tagline">
                Experience the rise of the greatest entrep√¥t in Southeast Asia. Manage trade, maintain sovereignty, and
                defend your legacy.</p>

            <div
                style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 40px; text-align: left;">
                <div
                    style="background: rgba(255,255,255,0.05); padding: 15px 25px; border-radius: 12px; font-size: 0.9rem; width: 45%;">
                    ‚õµ <span data-i18n="tip_1">Collect Merchant Ships for Port Revenue.</span></div>
                <div
                    style="background: rgba(255,255,255,0.05); padding: 15px 25px; border-radius: 12px; font-size: 0.9rem; width: 45%;">
                    üìú <span data-i18n="tip_2">Capture Royal Seals to boost sovereignty.</span></div>
                <div
                    style="background: rgba(255,255,255,0.05); padding: 15px 25px; border-radius: 12px; font-size: 0.9rem; width: 45%;">
                    üõ°Ô∏è <span data-i18n="tip_3">Click Laksamana for 'Tuah Focus'.</span></div>
                <div
                    style="background: rgba(255,255,255,0.05); padding: 15px 25px; border-radius: 12px; font-size: 0.9rem; width: 45%;">
                    ‚ö†Ô∏è <span data-i18n="tip_4">Avoid 'Fitnah' in the later eras.</span></div>
            </div>

            <button id="btn-begin" class="btn-main" data-i18n="begin">Begin Legacy</button>
        </div>
    </div>

    <!-- RESULT SCREEN -->
    <div id="end-screen" class="overlay hidden">
        <div class="card">
            <h1 data-i18n="end_title">Legacy Written</h1>
            <div class="stars">
                <div class="star" id="st-1">‚òÖ</div>
                <div class="star" id="st-2">‚òÖ</div>
                <div class="star" id="st-3">‚òÖ</div>
            </div>
            <div style="margin: 30px 0;">
                <p style="color: var(--primary); letter-spacing: 3px; font-weight: 800; text-transform: uppercase;"
                    data-i18n="final">Final Reserves</p>
                <div id="final-res" style="font-family: var(--font-serif); font-size: 5rem; font-weight: 900;">0</div>
            </div>
            <p id="evaluation" style="color: #ddd; font-size: 1.2rem; margin-bottom: 40px;"></p>
            <button id="btn-replay" class="btn-main" data-i18n="retry">Relive History</button>
        </div>
    </div>

    <script>
        /**
         * L10N
         */
        const LANGS = {
            en: {
                title: "Empire of Melaka",
                tagline: "Rule the world's most vital port. From the vision of Parameswara to the battle of 1511.",
                score: "Port Wealth",
                timer: "Timeline",
                glory: "Empire Glory",
                top: "Historic Record",
                begin: "Begin Legacy",
                retry: "Relive History",
                era_1: "The Founding - 1400",
                era_2: "The Rise - 1445",
                era_3: "Golden Era - 1460",
                era_4: "Defense of Melaka - 1511",
                tip_1: "Collect Merchant Ships for Port Revenue.",
                tip_2: "Royal Seals increase the Sultanate's Glory.",
                tip_3: "Capture Laksamana for 'Tuah Power'.",
                tip_4: "Avoid 'Fitnah' icons in later eras.",
                end_title: "History Written",
                final: "Total Reserves",
                eval_3: "Legendary! Your Sultanate reached the pinnacle of global trade.",
                eval_2: "A Golden Age! Melaka flourished under your guidance.",
                eval_1: "A solid effort. The port remains vibrant.",
                eval_0: "Melaka fell too soon. Study history to build a stronger legacy."
            },
            bm: {
                title: "Empayar Melaka",
                tagline: "Perintah pelabuhan paling penting di dunia. Dari visi Parameswara ke pertempuran 1511.",
                score: "Kekayaan Port",
                timer: "Garis Masa",
                glory: "Kegemilangan",
                top: "Rekod Sejarah",
                begin: "Mula Sejarah",
                retry: "Main Semula",
                era_1: "Pengasasan - 1400",
                era_2: "Kebangkitan - 1445",
                era_3: "Zaman Keemasan - 1460",
                era_4: "Pertahanan Melaka - 1511",
                tip_1: "Kutip Kapal Pedagang untuk Keuntungan.",
                tip_2: "Mohon Diraja tingkatkan Kegemilangan.",
                tip_3: "Klik Laksamana untuk 'Mode Tuah'.",
                tip_4: "Elakkan ikon 'Fitnah' di fasa akhir.",
                end_title: "Sejarah Terukir",
                final: "Jumlah Rizab",
                eval_3: "Legendaris! Kesultanan anda mencapai puncak perdagangan dunia.",
                eval_2: "Zaman Keemasan! Melaka makmur di bawah pimpinan anda.",
                eval_1: "Satu usaha yang teguh. Pelabuhan kekal rancak.",
                eval_0: "Melaka jatuh terlalu awal. Pelajari sejarah untuk legasi lebih utuh."
            }
        };

        let currentLang = 'en';

        /**
         * ENGINE
         */
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const bgCanvas = document.getElementById('bg-canvas');
        const bgCtx = bgCanvas.getContext('2d');

        let width, height;
        let score = 0, glory = 1000, topScore = localStorage.getItem('melaka_high') || 0;
        let timeLeft = 120, gameActive = false, era = 1;
        let combo = 0, comboTime = 0;
        let tuahMode = false, tuahTime = 0;
        let entities = [], particles = [], lastTimestamp = 0;
        let spawnAcc = 0, factAcc = 0;

        const TYPES = {
            CN: { color: '#ff4757', score: 100 },
            IN: { color: '#3742fa', score: 120 },
            AR: { color: '#ffa502', score: 150 },
            SEAL: { color: '#ffd700', glory: 300, score: 500 },
            TUAH: { color: '#2ed573' },
            VIRUS: { color: '#2f3542', glory: -400 },
            BOSS: { color: '#333', score: 1200 }
        };

        class Entity {
            constructor(typeKey, isBoss = false) {
                this.typeKey = typeKey;
                this.config = TYPES[typeKey];
                this.isBoss = isBoss;
                this.size = isBoss ? 160 : 75;
                this.x = Math.random() * (width - this.size) + this.size / 2;
                this.y = isBoss ? -200 : height + 100;

                const speedIdx = (120 - timeLeft) / 120; // 0 to 1
                const baseSpeed = isBoss ? 0.6 : (0.8 + speedIdx * 0.5);
                this.vy = isBoss ? baseSpeed : -baseSpeed;

                this.dead = false;
                this.hp = isBoss ? 2 : 1;
                this.phase = Math.random() * Math.PI * 2;
            }

            update(dt) {
                const spd = tuahMode ? 0.4 : 1;
                this.y += this.vy * spd;
                this.x += Math.sin(this.y * 0.01 + this.phase) * 0.4;

                if (this.isBoss && this.y > height) {
                    this.dead = true;
                    glory -= 500; updateHUD();
                    screenShake();
                } else if (!this.isBoss && this.y < -150) {
                    this.dead = true;
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(Math.sin(this.y * 0.02) * 0.05);

                const clr = this.config.color;
                if (this.typeKey === 'SEAL') {
                    this.drawSeal();
                } else if (this.typeKey === 'TUAH') {
                    this.drawTuah();
                } else if (this.typeKey === 'VIRUS') {
                    this.drawVirus();
                } else if (this.isBoss) {
                    this.drawBoss();
                } else {
                    this.drawShip(clr);
                }

                ctx.restore();
            }

            drawShip(c) {
                ctx.fillStyle = '#4a3219';
                ctx.beginPath();
                ctx.moveTo(-35, 10); ctx.lineTo(35, 10); ctx.lineTo(25, 30); ctx.lineTo(-25, 30);
                ctx.fill();
                ctx.fillStyle = c;
                ctx.fillRect(5, -45, 20, 15);
                ctx.fillStyle = 'rgba(255,255,255,0.9)';
                ctx.beginPath();
                ctx.moveTo(-20, 10); ctx.lineTo(0, -60); ctx.lineTo(20, 10); ctx.fill();
            }

            drawSeal() {
                ctx.fillStyle = '#daA520';
                ctx.beginPath(); ctx.arc(0, 0, 30, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
                ctx.fillStyle = '#fff'; ctx.font = 'bold 20px serif';
                ctx.textAlign = 'center'; ctx.fillText('Èäò', 0, 8);
            }

            drawTuah() {
                ctx.fillStyle = '#2ed573';
                ctx.beginPath(); ctx.moveTo(0, -40); ctx.lineTo(30, 15); ctx.lineTo(-30, 15); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 3; ctx.stroke();
            }

            drawVirus() {
                ctx.fillStyle = '#111';
                ctx.beginPath(); ctx.arc(0, 0, 35, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#ff4757'; ctx.font = 'bold 45px sans-serif';
                ctx.textAlign = 'center'; ctx.fillText('!', 0, 16);
            }

            drawBoss() {
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(-80, 0, 160, 50);
                ctx.fillStyle = '#fff';
                ctx.fillRect(-60, -130, 50, 110);
                ctx.fillRect(20, -100, 40, 90);
                ctx.strokeStyle = 'red'; ctx.lineWidth = 6;
                ctx.beginPath(); ctx.moveTo(-45, -120); ctx.lineTo(-25, -20); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-25, -120); ctx.lineTo(-45, -20); ctx.stroke();
            }

            onClick() {
                this.hp--;
                if (this.hp <= 0) {
                    this.dead = true;
                    this.handleReward();
                    spawnParticles(this.x, this.y, this.config.color || '#fff');
                } else {
                    popWorldText("HIT", this.x, this.y, '#fff');
                }
            }

            handleReward() {
                if (this.typeKey === 'TUAH') {
                    activateTuah();
                    return;
                }
                if (this.typeKey === 'VIRUS') {
                    glory -= 400; if (glory < 0) glory = 0;
                    popWorldText("-400 GLORY", this.x, this.y, '#ff4757');
                    updateHUD();
                    return;
                }

                let pts = this.config.score || 0;
                let gl = this.config.glory || 0;

                if (tuahMode) pts *= 1.5;
                const m = 1 + (combo * 0.05);
                const final = Math.floor(pts * m);

                score += final;
                glory += gl;
                combo++;
                comboTime = 3.0;

                popWorldText("+" + final, this.x, this.y, '#fff');
                if (gl > 0) popWorldText("+" + gl + " GLORY", this.x, this.y - 40, '#ffd700');
                updateHUD();
            }
        }

        /**
         * FLOW
         */
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            bgCanvas.width = width;
            bgCanvas.height = height;
            drawStaticBG();
        }

        function drawStaticBG() {
            const g = bgCtx.createLinearGradient(0, 0, 0, height);
            g.addColorStop(0, '#0a1d30');
            g.addColorStop(1, '#020c1b');
            bgCtx.fillStyle = g;
            bgCtx.fillRect(0, 0, width, height);
        }

        function loop(ts) {
            if (!gameActive) return;
            const dt = (ts - lastTimestamp) / 1000;
            lastTimestamp = ts;

            ctx.clearRect(0, 0, width, height);

            // Time & Era
            timeLeft -= dt;
            if (timeLeft <= 0) { timeLeft = 0; endGame(); }
            updateEra();

            // Progress
            document.getElementById('progress-fill').style.width = ((120 - timeLeft) / 120 * 100) + '%';
            document.getElementById('time-val').innerText = Math.ceil(timeLeft);

            // Combo Decay
            if (combo > 0) {
                comboTime -= dt;
                if (comboTime <= 0) combo = 0;
                document.getElementById('combo-fill').style.width = (comboTime / 3 * 100) + '%';
            }

            // Powerup
            if (tuahMode) {
                tuahTime -= dt;
                if (tuahTime <= 0) tuahMode = false;
            }

            // Spawn
            spawnAcc += dt;
            const rate = (era === 4) ? 0.9 : 1.3 / (1 + (120 - timeLeft) / 100);
            if (spawnAcc > rate) {
                spawnAcc = 0;
                spawnLogic();
            }

            // Entities
            for (let i = entities.length - 1; i >= 0; i--) {
                entities[i].update(dt);
                entities[i].draw();
                if (entities[i].dead) entities.splice(i, 1);
            }

            // Particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx; p.y += p.vy;
                p.alpha -= 0.02;
                ctx.globalAlpha = p.alpha;
                ctx.fillStyle = p.c;
                ctx.fillRect(p.x, p.y, 4, 4);
                if (p.alpha <= 0) particles.splice(i, 1);
            }
            ctx.globalAlpha = 1;

            // Facts
            factAcc += dt;
            if (factAcc > 15) { factAcc = 0; postFact(); }

            requestAnimationFrame(loop);
        }

        function spawnLogic() {
            const r = Math.random();
            const elapsed = 120 - timeLeft;
            if (elapsed < 30) {
                if (r < 0.8) entities.push(new Entity('CN'));
                else entities.push(new Entity('SEAL'));
            } else if (elapsed < 60) {
                if (r < 0.4) entities.push(new Entity('CN'));
                else if (r < 0.7) entities.push(new Entity('IN'));
                else if (r < 0.9) entities.push(new Entity('SEAL'));
                else entities.push(new Entity('TUAH'));
            } else if (elapsed < 90) {
                if (r < 0.3) entities.push(new Entity('IN'));
                else if (r < 0.5) entities.push(new Entity('AR'));
                else if (r < 0.7) entities.push(new Entity('VIRUS'));
                else if (r < 0.9) entities.push(new Entity('SEAL'));
                else entities.push(new Entity('TUAH'));
            } else {
                if (r < 0.5) entities.push(new Entity('BOSS', true));
                else if (r < 0.75) entities.push(new Entity('VIRUS'));
                else entities.push(new Entity('SEAL'));
            }
        }

        function updateHUD() {
            document.getElementById('score-val').innerText = Math.floor(score);
            document.getElementById('glory-val').innerText = glory;
            document.getElementById('top-val').innerText = topScore;
        }

        function updateEra() {
            const old = era;
            if (timeLeft < 30) era = 4;
            else if (timeLeft < 60) era = 3;
            else if (timeLeft < 90) era = 2;
            else era = 1;

            if (old !== era) {
                document.getElementById('current-era-name').innerText = LANGS[currentLang]['era_' + era];
            }
        }

        function activateTuah() {
            tuahMode = true;
            tuahTime = 8.0;
            popWorldText("LAKSAMANA FOCUS", width / 2, height / 2, '#2ed573');
            screenShake();
        }

        function popWorldText(t, x, y, c) {
            const el = document.createElement('div');
            el.className = 'float-text';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.color = c;
            el.innerText = t;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1200);
        }

        function postFact() {
            const facts = [
                "Parameswara established Melaka near the Bertam river mouth.",
                "The Sultanate's administrative hierarchy was the 'Empat Lipatan' system.",
                "Melaka's location was protected from monsoons by Sumatra and the Titiwangsa range.",
                "Envoys from China (Zheng He) solidified diplomatic security.",
                "Traders from the Middle East, India, and China made Melaka an Entrep√¥t.",
                "The fall in 1511 was partially caused by betrayal within the leadership."
            ];
            const chip = document.createElement('div');
            chip.className = 'fact-chip';
            chip.innerText = "üìú " + facts[Math.floor(Math.random() * facts.length)];
            document.getElementById('toast-bin').appendChild(chip);
            setTimeout(() => chip.remove(), 6000);
        }

        function spawnParticles(x, y, c) {
            for (let i = 0; i < 15; i++) {
                particles.push({
                    x, y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10,
                    alpha: 1.0, c
                });
            }
        }

        function screenShake() {
            canvas.style.transform = 'translate(10px, 10px)';
            setTimeout(() => canvas.style.transform = 'translate(0,0)', 100);
        }

        /**
         * INITIALIZE
         */
        function startGame() {
            score = 0; glory = 1000; timeLeft = 120; era = 1;
            entities = []; particles = [];
            gameActive = true;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.add('hidden');
            lastTimestamp = performance.now();
            updateHUD();
            requestAnimationFrame(loop);
        }

        function endGame() {
            gameActive = false;
            const final = score + (glory * 5);
            document.getElementById('final-res').innerText = final;
            document.getElementById('end-screen').classList.remove('hidden');

            let st = 0;
            if (final > 8000) st = 1;
            if (final > 18000) st = 2;
            if (final > 30000) st = 3;

            document.querySelectorAll('.star').forEach((s, i) => {
                s.classList.remove('won');
                if (i < st) setTimeout(() => s.classList.add('won'), (i + 1) * 500);
            });

            document.getElementById('evaluation').innerText = LANGS[currentLang]['eval_' + st];

            if (final > topScore) {
                topScore = final;
                localStorage.setItem('melaka_high', topScore);
            }
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!gameActive) return;
            const r = canvas.getBoundingClientRect();
            const mx = e.clientX - r.left, my = e.clientY - r.top;

            let hit = false;
            for (let i = entities.length - 1; i >= 0; i--) {
                const dist = Math.hypot(entities[i].x - mx, entities[i].y - my);
                if (dist < entities[i].size / 1.5) {
                    entities[i].onClick();
                    hit = true;
                    break;
                }
            }
            if (!hit) combo = 0;
        });

        document.getElementById('lang-swap').addEventListener('click', () => {
            currentLang = currentLang === 'en' ? 'bm' : 'en';
            updateUI();
        });

        function updateUI() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const k = el.getAttribute('data-i18n');
                if (LANGS[currentLang][k]) el.innerText = LANGS[currentLang][k];
            });
            document.getElementById('current-era-name').innerText = LANGS[currentLang]['era_' + era];
            updateHUD();
        }

        document.getElementById('btn-begin').addEventListener('click', startGame);
        document.getElementById('btn-replay').addEventListener('click', startGame);

        window.addEventListener('resize', resize);
        resize();
        updateUI();

    </script>
</body>

</html>