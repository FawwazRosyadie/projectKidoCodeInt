<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alam Melayu: Empire Architect (Deluxe Version)</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;600;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-gold: #ffd700;
            --gold-glow: rgba(255, 215, 0, 0.4);
            --accent-red: #d40000;
            --deep-royal: #1a1a2e;
            --glass-bg: rgba(26, 26, 46, 0.85);
            --glass-border: rgba(255, 215, 0, 0.3);
            --text-light: #fdfdfd;
            --rice-green: #4caf50;
            --sea-blue: #00bcd4;
            --forest-brown: #795548;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-gold) transparent;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: #050505 url('bg.png') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-light);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Animations --- */
        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        @keyframes pulse-gold {
            0% {
                box-shadow: 0 0 5px var(--gold-glow);
            }

            50% {
                box-shadow: 0 0 20px var(--gold-glow);
            }

            100% {
                box-shadow: 0 0 5px var(--gold-glow);
            }
        }

        @keyframes slide-in-top {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes ship-move {
            0% {
                left: -10%;
                transform: scaleX(1);
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                left: 110%;
                transform: scaleX(1);
                opacity: 0;
            }
        }

        /* --- UI Layers --- */
        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(4px) saturate(1.2);
        }

        header {
            height: 80px;
            padding: 0 40px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.9), transparent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            animation: slide-in-top 0.8s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .main-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .main-logo h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            background: linear-gradient(45deg, var(--primary-gold), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        /* --- Top Resource Bar --- */
        .resources-bar {
            display: flex;
            gap: 25px;
            background: var(--glass-bg);
            padding: 10px 30px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .res-pill {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .res-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 800;
            color: var(--primary-gold);
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        .res-value {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* --- Main Content Grid --- */
        .game-layout {
            flex: 1;
            display: grid;
            grid-template-columns: 350px 1fr 350px;
            gap: 25px;
            padding: 25px;
            overflow: hidden;
        }

        .side-panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .panel-tab-btn {
            background: rgba(255, 215, 0, 0.1);
            color: var(--primary-gold);
            border: none;
            padding: 15px;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            font-size: 0.9rem;
        }

        .panel-tab-btn.active {
            background: var(--primary-gold);
            color: #000;
        }

        .panel-header {
            padding: 15px 20px;
            background: rgba(255, 215, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--glass-border);
        }

        .panel-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* --- World View (Center Piece) --- */
        .viewport {
            position: relative;
            background: radial-gradient(circle, rgba(26, 26, 46, 0.4) 0%, rgba(0, 0, 0, 0.6) 100%);
            border-radius: 30px;
            border: 2px solid var(--glass-border);
            overflow: hidden;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.8);
        }

        #world-map {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
        }

        /* Weather Effects Overlay */
        #weather-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            transition: background 2s;
        }

        .rain {
            background: rgba(0, 0, 80, 0.2) url('https://cdn.pixabay.com/photo/2016/11/18/12/36/rain-1834193_960_720.png');
            animation: rain 0.3s linear infinite;
        }

        @keyframes rain {
            from {
                background-position: 0 0;
            }

            to {
                background-position: 0 100%;
            }
        }

        /* --- Interactive Assets --- */
        .kingdom-node {
            position: absolute;
            cursor: pointer;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        .kingdom-node:hover {
            transform: translate(-50%, -50%) scale(1.15);
            filter: drop-shadow(0 0 15px var(--primary-gold));
        }

        .node-icon {
            font-size: 3.5rem;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.8));
            position: relative;
        }

        .node-label {
            margin-top: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid var(--primary-gold);
            color: #fff;
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
        }

        /* Visual Kingdom Upgrades */
        .building-layer {
            position: absolute;
            bottom: 10%;
            width: 100%;
            height: 40%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            pointer-events: none;
        }

        .building-spot {
            width: 80px;
            height: 80px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px dashed var(--glass-border);
            border-radius: 10px;
            transition: all 0.5s;
        }

        .building-spot.active {
            border: none;
            background: none;
            animation: float 4s infinite ease-in-out;
        }

        /* --- Cards & Components --- */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.15);
            transition: transform 0.2s;
        }

        .card:hover {
            border-color: var(--primary-gold);
            background: rgba(255, 215, 0, 0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .card-title {
            font-weight: 800;
            color: var(--primary-gold);
            font-size: 0.9rem;
        }

        .card-desc {
            font-size: 0.75rem;
            color: #bbb;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .btn {
            width: 100%;
            padding: 8px 15px;
            background: linear-gradient(135deg, #FFD700, #B8860B);
            color: #000;
            border: none;
            border-radius: 8px;
            font-weight: 800;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Cinzel', serif;
        }

        .btn:disabled {
            filter: grayscale(1) opacity(0.5);
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--gold-glow);
        }

        /* --- Notifications & Events --- */
        #notification-box {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: var(--glass-bg);
            border-left: 5px solid var(--primary-gold);
            padding: 12px 25px;
            border-radius: 4px;
            color: #fff;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            animation: slide-up 0.4s ease-out forwards;
        }

        @keyframes slide-up {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal Overlays */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 5000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: var(--deep-royal);
            width: 700px;
            max-width: 90%;
            border: 2px solid var(--primary-gold);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .modal-content h2 {
            font-family: 'Cinzel', serif;
            font-size: 3rem;
            color: var(--primary-gold);
            margin-bottom: 20px;
        }

        /* Scrollable Tutorial Info */
        .tutorial-text {
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 25px;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        /* System Info Pill (Non-intrusive) */
        #system-info {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 20px;
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--primary-gold);
            z-index: 90;
            pointer-events: none;
        }

        /* --- Hide/Show Utils --- */
        .hidden {
            display: none !important;
        }

        /* Red for danger/errors */
        .text-red {
            color: #ff5252;
        }

        .text-gold {
            color: var(--primary-gold);
        }

        /* High Score Display */
        .top-score-box {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: var(--glass-bg);
            padding: 10px 20px;
            border-radius: 50px;
            border: 1px solid var(--primary-gold);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            font-weight: 800;
        }
    </style>
</head>

<body>

    <div id="game-wrapper">
        <!-- System Status Info -->
        <div id="system-info">Season: Monsoon (Trade Speed -20%)</div>

        <!-- Header -->
        <header>
            <div class="main-logo">
                <span style="font-size: 2.5rem;">üëë</span>
                <h1 data-key="game_title">Alam Melayu: Empire Architect</h1>
            </div>

            <div class="resources-bar">
                <div class="res-pill">
                    <span class="res-label" data-key="res_rice">Rice (Beras)</span>
                    <div class="res-value"><span style="color:var(--rice-green)">üåæ</span> <span id="val-rice">0</span>
                    </div>
                </div>
                <div class="res-pill">
                    <span class="res-label" data-key="res_gold">Wealth (Emas)</span>
                    <div class="res-value"><span style="color:var(--primary-gold)">üí∞</span> <span
                            id="val-gold">100</span></div>
                </div>
                <div class="res-pill" style="min-width: 120px;">
                    <span class="res-label" data-key="res_power">Influence (Wibawa)</span>
                    <div class="res-value"><span style="color:var(--accent-red)">üî•</span> <span id="val-power">0</span>
                    </div>
                </div>
                <div class="res-pill">
                    <span class="res-label" data-key="res_score">Score</span>
                    <div class="res-value" id="val-score" style="color: #fff">0</div>
                </div>
            </div>

            <div style="display: flex; gap: 20px; align-items: center;">
                <div id="timer-display"
                    style="font-family: 'Cinzel', serif; font-size: 1.5rem; color: var(--accent-red); font-weight: 700;">
                    10:00</div>
                <button class="btn" style="width: auto; padding: 10px 20px;" id="btn-lang"
                    onclick="toggleLanguage()">Language: MS</button>
            </div>
        </header>

        <!-- Main Workspace -->
        <main class="game-layout">

            <!-- Left Panel: Administration (Government) -->
            <section class="side-panel">
                <div style="display: flex;">
                    <button class="panel-tab-btn active" onclick="switchTab('gov', 'admin-tab')"
                        data-key="tab_admin">Pentadbiran</button>
                    <button class="panel-tab-btn" onclick="switchTab('gov', 'history-tab')"
                        data-key="tab_edu">Ensiklopedia</button>
                </div>
                <div class="panel-header">
                    <span data-key="section_gov">Sistem Pemerintahan</span>
                    <span id="gov-influence-level">Lvl 1</span>
                </div>
                <div class="panel-content" id="admin-panel-list">
                    <!-- Dynamic Official Cards -->
                </div>
                <!-- History/Educational Tab (Hidden by default) -->
                <div class="panel-content hidden" id="history-panel-content">
                    <div class="card">
                        <p class="card-desc" style="color:gold">Did You Know?</p>
                        <p id="historical-fact">Loading facts...</p>
                    </div>
                </div>
            </section>

            <!-- Center Panel: The World -->
            <section class="viewport">
                <div id="weather-overlay"></div>
                <div id="world-map">
                    <!-- Interactive Nodes -->
                    <div class="kingdom-node" style="top: 30%; left: 30%;" onclick="interactNode('farm', event)">
                        <div class="node-icon">üåæ</div>
                        <div class="node-label" data-key="node_farm">Valley of Plenty</div>
                    </div>
                    <div class="kingdom-node" style="top: 20%; left: 70%;" onclick="interactNode('forest', event)">
                        <div class="node-icon">üêÖ</div>
                        <div class="node-label" data-key="node_forest">Royal Jungle</div>
                    </div>
                    <div class="kingdom-node" style="bottom: 10%; left: 50%;" onclick="interactNode('port', event)">
                        <div class="node-icon">‚õµ</div>
                        <div class="node-label" data-key="node_port">Empire Harbor</div>
                    </div>
                    <div class="kingdom-node" style="bottom: 35%; right: 15%;" onclick="interactNode('mine', event)">
                        <div class="node-icon">üíé</div>
                        <div class="node-label" data-key="node_mine">Golden Hills</div>
                    </div>

                    <!-- Visual Kingdom Growth -->
                    <div class="building-layer">
                        <div class="building-spot" id="spot-1"></div>
                        <div class="building-spot" id="spot-2"></div>
                        <div class="building-spot" id="spot-3"></div>
                        <div class="building-spot" id="spot-4"></div>
                        <div class="building-spot" id="spot-5"></div>
                    </div>
                </div>
            </section>

            <!-- Right Panel: Economy & Trade -->
            <section class="side-panel">
                <div class="panel-header">
                    <span data-key="section_econ">Kegiatan Ekonomi</span>
                    <span>üìà</span>
                </div>
                <div class="panel-content" id="market-panel-list">
                    <!-- Dynamic Upgrade Cards -->
                </div>
                <div style="padding: 20px; border-top: 1px solid var(--glass-border);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="font-size: 0.8rem;" data-key="empire_rank">Pangkat Empayar:</span>
                        <span id="txt-empire-rank" style="font-weight: 800; color: var(--primary-gold);">Village</span>
                    </div>
                    <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;">
                        <div id="progress-empire"
                            style="width: 10%; height: 100%; background: var(--primary-gold); border-radius: 3px; transition: width 0.5s;">
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Start Overlay -->
    <div id="start-overlay" class="overlay">
        <div class="modal-content">
            <h2 data-key="start_title">Empire Architect</h2>
            <div class="tutorial-text" data-key="start_instruction">
                Welcome, Ruler. You have been chosen to govern one of the legendary kingdoms of Alam Melayu.
                <br><br>
                <b>Objective:</b> Grow your kingdom into a Golden Empire (Zaman Keemasan).
                <br><br>
                <b>Administration:</b> Appoint officials like the <i>Wazir</i> or <i>Syahbandar</i> to automate and
                boost your influence.
                <br><br>
                <b>Economy:</b> Harvest resources from the map and upgrade your trade systems. Watch out for seasons!
                The Monsoon affects your trade ports.
            </div>

            <div style="display: flex; flex-direction: column; gap: 20px; align-items: center;">
                <div style="display: flex; gap: 15px; align-items: center;">
                    <span style="font-weight: 800;" data-key="choose_kingdom">CHOOSE YOUR KINGDOM:</span>
                    <select id="kingdom-select"
                        style="background: #111; color: gold; border: 2px solid gold; padding: 10px 20px; font-family: 'Cinzel'; border-radius: 5px; cursor: pointer;">
                        <option value="funan">FUNAN (Agricultural Pioneer)</option>
                        <option value="srivijaya">SRIVIJAYA (Maritime Mastery)</option>
                        <option value="angkor">ANGKOR (The Great Irrigation)</option>
                        <option value="majapahit">MAJAPAHIT (Global Trade Hub)</option>
                    </select>
                </div>
                <button class="btn" style="width: 300px; padding: 20px; font-size: 1.2rem;" onclick="startGame()">ASCEND
                    THE THRONE</button>
            </div>
        </div>
    </div>

    <!-- Choice Event Overlay -->
    <div id="event-overlay" class="overlay hidden">
        <div class="modal-content">
            <span style="font-size: 5rem;" id="event-icon">üö¢</span>
            <h2 id="event-title">Royal Decree</h2>
            <p id="event-desc" style="margin: 20px 0; font-size: 1.1rem; color: #ccc;">A merchant fleet from the West
                seeks special privileges. How shall you respond?</p>
            <div id="event-options" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Choice buttons injected here -->
            </div>
        </div>
    </div>

    <!-- Game Over Overlay -->
    <div id="end-overlay" class="overlay hidden">
        <div class="modal-content">
            <h2 id="end-h2">The Era Ends</h2>
            <div style="font-size: 1.5rem; margin: 30px 0;">
                <div data-key="final_score">Legacy Score: <b id="final-score-val" style="color: gold;">0</b></div>
                <div data-key="final_rank">Kingdom Status: <b id="final-rank-val" style="color: gold;">Village</b></div>
            </div>
            <div id="end-medals" style="font-size: 3rem; margin-bottom: 30px;">
                <!-- Medals here -->
            </div>
            <button class="btn" onclick="location.reload()" style="padding: 15px 40px;">RULE A NEW AGE</button>
        </div>
    </div>

    <!-- Toast / Note container -->
    <div id="notification-box"></div>

    <!-- Top Score (Fixed) -->
    <div class="top-score-box">
        <span>üèÜ TOP LEGACY:</span>
        <span id="top-score-val">0</span>
    </div>

    <script>
        /* --- Translation & Content Data --- */
        const content = {
            en: {
                game_title: "Alam Melayu: Empire Architect",
                res_rice: "Rice (Beras)",
                res_gold: "Wealth (Gold)",
                res_power: "Influence (Wibawa)",
                res_score: "Legacy Score",
                tab_admin: "Administration",
                tab_edu: "Encyclopedia",
                section_gov: "Governance System",
                section_econ: "Economic Activities",
                node_farm: "Valley of Plenty",
                node_forest: "Royal Jungle",
                node_port: "Empire Harbor",
                node_mine: "Golden Hills",
                empire_rank: "Empire Rank:",
                start_title: "Rise of Empires",
                final_score: "Legacy Score",
                final_rank: "Kingdom Status",
                choose_kingdom: "CHOOSE YOUR KINGDOM:",
                needs_gold: "Not enough Wealth!",
                appointed: "Official Appointed!",
                upgrade_purchased: "Expansion Complete!",
                monsoon: "Season: Monsoon (Trade Speed -30%)",
                harvest_season: "Season: Harvest (Rice Yield +50%)",
                tax_season: "Season: Tax Collection (Resource Growth Up)",
                drought: "Season: Drought (Rice Growth -50%)"
            },
            ms: {
                game_title: "Alam Melayu: Arkitek Empayar",
                res_rice: "Beras (Rice)",
                res_gold: "Kekayaan (Emas)",
                res_power: "Wibawa (Influence)",
                res_score: "Skor Legasi",
                tab_admin: "Pentadbiran",
                tab_edu: "Ensiklopedia",
                section_gov: "Sistem Pemerintahan",
                section_econ: "Kegiatan Ekonomi",
                node_farm: "Lembah Melimpah",
                node_forest: "Hutan Diraja",
                node_port: "Pelabuhan Empayar",
                node_mine: "Bukit Emas",
                empire_rank: "Pangkat Empayar:",
                start_title: "Kebangkitan Empayar",
                final_score: "Skor Legasi",
                final_rank: "Status Kerajaan",
                choose_kingdom: "PILIH KERAJAAN ANDA:",
                needs_gold: "Kekayaan tidak mencukupi!",
                appointed: "Pembesar Dilantik!",
                upgrade_purchased: "Perluasan Selesai!",
                monsoon: "Musim: Monsun (Kelajuan Trade -30%)",
                harvest_season: "Musim: Menuai (Hasil Beras +50%)",
                tax_season: "Musim: Pungutan Cukai (Hasil Meningkat)",
                drought: "Musim: Kemarau (Hasil Beras -50%)"
            }
        };

        const historicalFacts = [
            "Kerajaan Funan merupakan kerajaan terawal di Alam Melayu, terkenal dengan sistem pengairan (Baray).",
            "Srivijaya menjadi kuasa maritim utama kerana penguasaan terhadap Selat Melaka dan Selat Sunda.",
            "Angkor mempunyai Baray yang sangat luas untuk menyimpan air bagi pertanian padi sepanjang tahun.",
            "Majapahit mempunyai majlis penasihat Raja yang dipanggil Sapta Prabhu.",
            "Syahbandar bertanggungjawab mengurus pelabuhan, perdagangan, dan keselamatan pedagang asing.",
            "Padi merupakan tanaman utama kerana kawasan lembangan sungai yang subur (Mekong, Musi, Solo).",
            "Gaharu, kapur barus, dan rempah-ratus merupakan hasil hutan dan laut yang sangat dicari oleh pedagang luar.",
            "Kerajaan Alam Melayu mengamalkan sistem Kedatuan (Srivijaya) dan Rajadhiraja (Champa)."
        ];

        /* --- Game State --- */
        let state = {
            lang: 'en',
            active: false,
            resources: { rice: 0, gold: 100, power: 0, score: 0 },
            kingdom: 'funan',
            timer: 600, // 10 minutes
            season: 'normal',
            rank: 'Village',
            rankScore: 0,
            officials: [],
            upgrades: [],
            buildings: 0,
            unlocks: {
                castle: false,
                port_upgraded: false,
                temple: false
            }
        };

        const officialsData = [
            { id: 'wazir', name_en: 'Wazir (Vizier)', name_ms: 'Wazir', cost: 150, influence: 5, auto_gold: 1, desc_en: "Advises the King on national policy.", desc_ms: "Menasihati Raja dalam urusan dasar negara." },
            { id: 'datu', name_en: 'Datu', name_ms: 'Datu', cost: 200, influence: 8, auto_rice: 2, desc_en: "Manages regional administration.", desc_ms: "Menguruskan pentadbiran wilayah." },
            { id: 'syahbandar', name_en: 'Syahbandar', name_ms: 'Syahbandar', cost: 300, influence: 10, bonus_trade: 0.5, desc_en: "Handles ports and foreign trade.", desc_ms: "Mengurus pelabuhan dan dagangan asing." },
            { id: 'temenggung', name_en: 'Temenggung', name_ms: 'Temenggung', cost: 500, influence: 15, auto_score: 5, desc_en: "Head of internal security.", desc_ms: "Ketua keselamatan dalam negeri." },
            { id: 'pradesa', name_en: 'Pradesa', name_ms: 'Pradesa', cost: 800, influence: 20, multi: 1.1, desc_en: "District administrator (Majapahit).", desc_ms: "Pentadbir daerah (Zaman Majapahit)." }
        ];

        const economyData = [
            { id: 'irrigation', name_en: 'Baray System', name_ms: 'Sistem Baray', cost: 100, effect: 'rice_boost', desc_en: "Huge reservoirs to maintain water flow.", desc_ms: "Takungan air untuk bekalan pertanian." },
            { id: 'fleet', name_en: 'Merchant Fleet', name_ms: 'Armada Dagang', cost: 250, effect: 'gold_boost', desc_en: "Increases trade income speed.", desc_ms: "Meningkatkan kelajuan hasil trade." },
            { id: 'taxes', name_en: 'Taxation Office', name_ms: 'Pejabat Cukai', cost: 400, effect: 'all_round', desc_en: "Collect gold from forest & sea products.", desc_ms: "Pungutan cukai hasil hutan dan laut." },
            { id: 'embassy', name_en: 'Diplomatic Hub', name_ms: 'Pusat Diplomasi', cost: 700, effect: 'power_boost', desc_en: "Gains influence from foreign relations.", desc_ms: "Meningkatkan wibawa melalui hubungan luar." }
        ];

        /* --- Initialization --- */

        function toggleLanguage() {
            state.lang = state.lang === 'en' ? 'ms' : 'en';
            document.getElementById('btn-lang').innerText = state.lang === 'en' ? 'Language: MS' : 'Bahasa: EN';
            updateUIStrings();
            renderPanels();
        }

        function updateUIStrings() {
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (content[state.lang][key]) el.innerText = content[state.lang][key];
            });
        }

        function startGame() {
            state.kingdom = document.getElementById('kingdom-select').value;
            state.active = true;
            document.getElementById('start-overlay').classList.add('hidden');

            // Starting bonuses
            if (state.kingdom === 'srivijaya') state.resources.gold += 200;
            if (state.kingdom === 'angkor') state.resources.rice += 100;

            renderPanels();
            startLoops();
            updateHistoricalFact();
            toast(`Reign of ${state.kingdom.toUpperCase()} begins!`);
        }

        /* --- Game Loops --- */

        function startLoops() {
            // Main Stat Loop (1 second)
            setInterval(() => {
                if (!state.active) return;

                // Passives
                officialsData.forEach(off => {
                    if (state.officials.includes(off.id)) {
                        if (off.auto_gold) state.resources.gold += off.auto_gold;
                        if (off.auto_rice) state.resources.rice += off.auto_rice;
                        if (off.auto_score) state.resources.score += off.auto_score;
                    }
                });

                // Resource decay/consumption (Small population need)
                if (state.resources.rice > 1 && Math.random() > 0.7) {
                    state.resources.rice -= 1;
                    state.resources.score += 2;
                }

                // Timer
                state.timer--;
                updateTimerDisplay();
                updateResources();
                checkRank();

                if (state.timer <= 0) endGame();
            }, 1000);

            // Season Loop (45 seconds)
            setInterval(triggerPhaseChange, 45000);

            // Random Event Loop (60-90 seconds)
            setTimeout(triggerRandomEvent, 20000);
        }

        function updateResources() {
            document.getElementById('val-rice').innerText = Math.floor(state.resources.rice);
            document.getElementById('val-gold').innerText = Math.floor(state.resources.gold);
            document.getElementById('val-power').innerText = Math.floor(state.resources.power);
            document.getElementById('val-score').innerText = Math.floor(state.resources.score);
        }

        function updateTimerDisplay() {
            const m = Math.floor(state.timer / 60);
            const s = state.timer % 60;
            document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        /* --- Rendering --- */

        function renderPanels() {
            const adminPanel = document.getElementById('admin-panel-list');
            const marketPanel = document.getElementById('market-panel-list');

            adminPanel.innerHTML = '';
            officialsData.forEach(off => {
                const owned = state.officials.includes(off.id);
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-title">${state.lang === 'en' ? off.name_en : off.name_ms}</span>
                        ${owned ? '<span style="color:#4caf50; font-size:0.75rem;">ACTIVE</span>' : ''}
                    </div>
                    <p class="card-desc">${state.lang === 'en' ? off.desc_en : off.desc_ms}</p>
                    ${!owned ? `<button class="btn" onclick="buyOfficial('${off.id}', ${off.cost})">APPOINT (${off.cost} üí∞)</button>` : ''}
                `;
                adminPanel.appendChild(card);
            });

            marketPanel.innerHTML = '';
            economyData.forEach(upg => {
                const count = state.upgrades.filter(x => x === upg.id).length;
                const cost = Math.floor(upg.cost * Math.pow(1.5, count));
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-title">${state.lang === 'en' ? upg.name_en : upg.name_ms}</span>
                        <span style="font-size:0.75rem; color:gold;">LVL ${count}</span>
                    </div>
                    <p class="card-desc">${state.lang === 'en' ? upg.desc_en : upg.desc_ms}</p>
                    <button class="btn" onclick="buyUpgrade('${upg.id}', ${cost})">EXPAND (${cost} üí∞)</button>
                `;
                marketPanel.appendChild(card);
            });
        }

        /* --- Gameplay Interactions --- */

        function buyOfficial(id, cost) {
            if (state.resources.gold >= cost) {
                state.resources.gold -= cost;
                state.officials.push(id);
                const off = officialsData.find(x => x.id === id);
                state.resources.power += off.influence;
                state.resources.score += 500;

                toast(content[state.lang].appointed);
                addBuildingVisual(id);
                renderPanels();
                updateResources();
            } else {
                toast(content[state.lang].needs_gold, 'red');
            }
        }

        function buyUpgrade(id, cost) {
            if (state.resources.gold >= cost) {
                state.resources.gold -= cost;
                state.upgrades.push(id);
                state.resources.score += 300;

                toast(content[state.lang].upgrade_purchased);
                renderPanels();
                updateResources();
            } else {
                toast(content[state.lang].needs_gold, 'red');
            }
        }

        function interactNode(type, event) {
            if (!state.active) return;

            let gain = 0;
            let res = "";
            let color = "";

            // Modifiers
            let mult = 1;
            if (state.season === 'harvest' && type === 'farm') mult = 1.8;
            if (state.season === 'monsoon' && type === 'port') mult = 0.5;

            state.upgrades.forEach(u => {
                if (u === 'irrigation' && type === 'farm') mult += 0.2;
                if (u === 'fleet' && type === 'port') mult += 0.3;
            });

            switch (type) {
                case 'farm':
                    gain = 10 * mult; res = "rice"; color = "#4caf50";
                    state.resources.score += 5;
                    break;
                case 'port':
                    if (state.resources.rice < 15) { toast("Need 15 Rice to Export!", "orange"); return; }
                    state.resources.rice -= 15;
                    gain = 50 * mult; res = "gold"; color = "#ffd700";
                    state.resources.score += 100;
                    break;
                case 'forest':
                case 'mine':
                    gain = 30; res = "gold"; color = "#deb887";
                    state.resources.score += 50;
                    break;
            }

            state.resources[res] += gain;
            spawnFloater(event.clientX, event.clientY, `+${Math.floor(gain)}`, color);
            updateResources();
        }

        /* --- Visual Updates --- */

        function addBuildingVisual(id) {
            const spots = document.querySelectorAll('.building-spot');
            for (let s of spots) {
                if (!s.classList.contains('active')) {
                    s.classList.add('active');
                    s.innerHTML = (id === 'wazir' || id === 'temenggung') ? '<span style="font-size:3rem">üèØ</span>' : '<span style="font-size:3rem">üõñ</span>';
                    state.buildings++;
                    break;
                }
            }
        }

        function spawnFloater(x, y, text, color) {
            const el = document.createElement('div');
            el.style.position = 'fixed';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.color = color;
            el.style.fontWeight = '800';
            el.style.pointerEvents = 'none';
            el.style.zIndex = '1000';
            el.innerText = text;
            el.style.transition = 'all 1s';
            document.body.appendChild(el);

            requestAnimationFrame(() => {
                el.style.transform = 'translateY(-100px)';
                el.style.opacity = '0';
            });
            setTimeout(() => el.remove(), 1000);
        }

        function toast(msg, type = 'gold') {
            const box = document.getElementById('notification-box');
            const t = document.createElement('div');
            t.className = 'toast';
            if (type === 'red') t.style.borderColor = '#ff5252';
            t.innerText = msg;
            box.appendChild(t);
            setTimeout(() => {
                t.style.opacity = '0';
                setTimeout(() => t.remove(), 500);
            }, 3000);
        }

        /* --- Systems: Seasons & Events --- */

        function triggerPhaseChange() {
            const seasons = ['normal', 'monsoon', 'harvest', 'tax', 'drought'];
            state.season = seasons[Math.floor(Math.random() * seasons.length)];

            const info = document.getElementById('system-info');
            const weather = document.getElementById('weather-overlay');
            weather.className = '';

            let key = "";
            switch (state.season) {
                case 'monsoon':
                    key = "monsoon";
                    weather.classList.add('rain');
                    break;
                case 'harvest': key = "harvest_season"; break;
                case 'tax': key = "tax_season"; break;
                case 'drought': key = "drought"; break;
                default: info.innerText = "Season: Stable (Calm Seas)"; break;
            }

            if (key) {
                const msg = content[state.lang][key];
                info.innerText = msg;
                toast(msg, 'cyan');
            }
        }

        function triggerRandomEvent() {
            if (!state.active) return;

            const eventOverlay = document.getElementById('event-overlay');
            const title = document.getElementById('event-title');
            const desc = document.getElementById('event-desc');
            const icon = document.getElementById('event-icon');
            const options = document.getElementById('event-options');

            const pool = [
                {
                    title_en: "Foreign Merchants", title_ms: "Pedagang Asing",
                    icon: "üõ≥Ô∏è",
                    desc_en: "Merchants from India wish to trade special textiles for spices.",
                    desc_ms: "Pedagang dari India mahu menukar tekstil khas dengan rempah-ratus.",
                    choices: [
                        { text_en: "Agree (Pay 50 Rice, Get 300 Gold)", text_ms: "Setuju (Bayar 50 Beras, Dapat 300 Emas)", action: () => { if (state.resources.rice >= 50) { state.resources.rice -= 50; state.resources.gold += 300; } } },
                        { text_en: "Refuse (Gain 50 Influence)", text_ms: "Tolak (Dapat 50 Wibawa)", action: () => { state.resources.power += 50; } }
                    ]
                },
                {
                    title_en: "Regional Conflict", title_ms: "Konflik Wilayah",
                    icon: "‚öîÔ∏è",
                    desc_en: "A neighboring village disputes your border markers.",
                    desc_ms: "Sebuah kampung jiran mempertikaikan penanda sempadan anda.",
                    choices: [
                        { text_en: "Send Wazir to Negotiate (Cost 100 Gold)", text_ms: "Hantar Wazir Berunding (Kos 100 Emas)", action: () => { state.resources.gold -= 100; state.resources.score += 1000; } },
                        { text_en: "Assert Dominance (Gain 100 Influence, lose 200 Gold)", text_ms: "Tunjukkan Kuasa (Dapat 100 Wibawa, hilang 200 Emas)", action: () => { state.resources.power += 100; state.resources.gold -= 200; } }
                    ]
                }
            ];

            const ev = pool[Math.floor(Math.random() * pool.length)];
            icon.innerText = ev.icon;
            title.innerText = state.lang === 'en' ? ev.title_en : ev.title_ms;
            desc.innerText = state.lang === 'en' ? ev.desc_en : ev.desc_ms;

            options.innerHTML = '';
            ev.choices.forEach(c => {
                const b = document.createElement('button');
                b.className = 'btn';
                b.style.padding = '15px';
                b.innerText = state.lang === 'en' ? c.text_en : c.text_ms;
                b.onclick = () => {
                    c.action();
                    eventOverlay.classList.add('hidden');
                    updateResources();
                };
                options.appendChild(b);
            });

            eventOverlay.classList.remove('hidden');

            // Next event
            setTimeout(triggerRandomEvent, 60000 + Math.random() * 30000);
        }

        /* --- Rank System --- */

        function checkRank() {
            const score = state.resources.score;
            let rank = "Village";
            let prog = 10;

            if (score > 2000) { rank = "Kingdom"; prog = 30; }
            if (score > 8000) { rank = "Great Kingdom"; prog = 60; }
            if (score > 20000) { rank = "Maritime Empire"; prog = 85; }
            if (score > 50000) { rank = "Golden Empire"; prog = 100; }

            state.rank = rank;
            document.getElementById('txt-empire-rank').innerText = rank;
            document.getElementById('progress-empire').style.width = prog + '%';

            const top = localStorage.getItem('alamMelayuTop') || 0;
            if (score > top) {
                localStorage.setItem('alamMelayuTop', Math.floor(score));
                document.getElementById('top-score-val').innerText = Math.floor(score);
            } else {
                document.getElementById('top-score-val').innerText = top;
            }
        }

        /* --- UI Helpers --- */

        function switchTab(panel, tab) {
            const admin = document.getElementById('admin-panel-list');
            const history = document.getElementById('history-panel-content');
            if (tab === 'admin-tab') {
                admin.classList.remove('hidden');
                history.classList.add('hidden');
            } else {
                admin.classList.add('hidden');
                history.classList.remove('hidden');
                updateHistoricalFact();
            }

            // Toggle active state on buttons
            document.querySelectorAll('.panel-tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function updateHistoricalFact() {
            const fact = historicalFacts[Math.floor(Math.random() * historicalFacts.length)];
            document.getElementById('historical-fact').innerText = fact;
        }

        function endGame() {
            state.active = false;
            document.getElementById('end-overlay').classList.remove('hidden');
            document.getElementById('final-score-val').innerText = Math.floor(state.resources.score);
            document.getElementById('final-rank-val').innerText = state.rank;

            const medals = document.getElementById('end-medals');
            medals.innerHTML = "";
            if (state.resources.score > 10000) medals.innerHTML += "ü•á";
            if (state.resources.score > 25000) medals.innerHTML += "üëë";
            if (state.resources.score > 50000) medals.innerHTML += "‚ú®";
        }

    </script>
</body>

</html>