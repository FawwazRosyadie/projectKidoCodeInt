<!DOCTYPE html>
<html lang="ms">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronicles of Alam Melayu: Heritage Guardian</title>
    <!-- Google Fonts for premium look -->
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-gold: #ffd700;
            --secondary-gold: #b8860b;
            --deep-blue: #0a192f;
            --accent-blue: #00d2ff;
            --heritage-gold: #fccb00;
            --religion-blue: #4fa4ff;
            --wisdom-green: #4ade80;
            --danger-red: #ff4d4d;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--deep-blue);
            color: #fff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #112240 0%, #0a192f 100%);
            overflow: hidden;
            cursor: none;
            /* Hide cursor in game */
        }

        /* Canvas Layers */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* HUD Overlay */
        #hud {
            position: absolute;
            top: 25px;
            left: 0;
            width: 100%;
            padding: 0 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 100;
            pointer-events: none;
        }

        .hud-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: auto;
        }

        .stat-box {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            padding: 12px 24px;
            border-radius: 16px;
            min-width: 160px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--primary-gold);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            font-family: 'Cinzel', serif;
            color: #fff;
        }

        /* Multiplier & Points Animation */
        .points-anim {
            position: absolute;
            color: var(--primary-gold);
            font-weight: 800;
            pointer-events: none;
            font-family: 'Cinzel', serif;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
            z-index: 150;
            animation: floatPop 1.2s forwards;
        }

        /* Guardian Shield */
        #guardian {
            position: absolute;
            bottom: 120px;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 5px solid var(--heritage-gold);
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 70%);
            transition: border-color 0.3s ease, background 0.3s ease;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
            left: 0;
            /* Positioned via JS */
            pointer-events: auto;
        }

        #guardian.mode-religion {
            border-color: var(--religion-blue);
            background: radial-gradient(circle, rgba(79, 164, 255, 0.2) 0%, transparent 70%);
            box-shadow: 0 0 30px rgba(79, 164, 255, 0.2);
        }

        .guardian-label {
            position: absolute;
            top: -45px;
            white-space: nowrap;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: #fff;
            text-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
            font-family: 'Cinzel', serif;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px 15px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }

        /* Overlay Screens */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            padding: 40px;
            animation: fadeIn 0.5s ease;
            cursor: auto;
        }

        .overlay h1 {
            font-family: 'Cinzel', serif;
            font-size: 4.5rem;
            color: var(--primary-gold);
            margin-bottom: 25px;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            letter-spacing: 5px;
            line-height: 1.1;
        }

        .overlay p {
            font-size: 1.3rem;
            max-width: 800px;
            line-height: 1.6;
            margin-bottom: 45px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 300;
        }

        .btn {
            padding: 18px 50px;
            font-size: 1.3rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 3px;
            border: 2px solid var(--primary-gold);
            background: rgba(255, 215, 0, 0.05);
            color: var(--primary-gold);
            border-radius: 60px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            margin: 15px;
            position: relative;
            overflow: hidden;
            z-index: 1100;
        }

        .btn:hover {
            background: var(--primary-gold);
            color: var(--deep-blue);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
            transform: translateY(-5px);
        }

        .lang-toggle {
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            padding: 10px 25px;
            font-size: 1rem;
            margin: 0;
            background: rgba(10, 25, 47, 0.6);
            backdrop-filter: blur(5px);
        }

        /* Star System */
        .stars-container {
            display: flex;
            gap: 20px;
            margin: 35px 0;
        }

        .star {
            font-size: 4rem;
            color: rgba(255, 255, 255, 0.1);
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .star.active {
            color: var(--primary-gold);
            text-shadow: 0 0 25px var(--primary-gold);
            transform: scale(1.2) rotate(15deg);
        }

        /* Instructions */
        .instructions {
            background: var(--glass-bg);
            padding: 35px;
            border-radius: 20px;
            margin-top: 45px;
            border: 1px solid var(--glass-border);
            max-width: 700px;
            text-align: left;
        }

        .instructions p {
            margin-bottom: 12px;
            font-size: 1.1rem;
            line-height: 1.4;
            color: #fff;
        }

        /* Achievement Banner */
        #achievement {
            position: absolute;
            top: 160px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.25), transparent);
            padding: 12px 60px;
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--primary-gold);
            opacity: 0;
            transition: all 0.5s ease;
            pointer-events: none;
            z-index: 20;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #achievement.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        /* Fact Bubble */
        #fact-bubble {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 25, 47, 0.85);
            backdrop-filter: blur(20px);
            padding: 22px 45px;
            border-radius: 40px;
            border: 1px solid var(--glass-border);
            max-width: 80%;
            text-align: center;
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            transform: translate(-50%, 30px);
            z-index: 1000;
            box-shadow: 0 15px 60px rgba(0, 0, 0, 0.6);
            pointer-events: none;
        }

        #fact-bubble.visible {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        /* Animations */
        @keyframes slideDown {
            from {
                transform: translateY(-40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes floatPop {
            0% {
                transform: scale(0.5) translateY(0);
                opacity: 0;
            }

            20% {
                transform: scale(1.3) translateY(-20px);
                opacity: 1;
            }

            100% {
                transform: scale(1) translateY(-140px);
                opacity: 0;
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .overlay h1 {
                font-size: 2.5rem;
                letter-spacing: 2px;
            }

            #hud {
                padding: 0 20px;
                top: 15px;
            }

            .stat-box {
                min-width: 120px;
                padding: 10px 15px;
            }

            .stat-value {
                font-size: 1.4rem;
            }

            #guardian {
                width: 100px;
                height: 100px;
                bottom: 80px;
            }

            .overlay p {
                font-size: 1.1rem;
            }

            .btn {
                padding: 15px 35px;
                font-size: 1.1rem;
            }

            #achievement {
                font-size: 1.4rem;
                top: 180px;
            }
        }
    </style>
</head>

<body>

    <button class="btn lang-toggle" id="lang-btn" onclick="game.toggleLanguage()" title="Switch Language">EN |
        MS</button>

    <div id="game-container">
        <canvas id="bg-canvas"></canvas>
        <canvas id="item-canvas"></canvas>
        <canvas id="particle-canvas"></canvas>

        <div id="hud">
            <div class="hud-group">
                <div class="stat-box">
                    <div class="stat-label" data-key="score_label">Score</div>
                    <div class="stat-value" id="score-val">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label" data-key="high_score_label">High Score</div>
                    <div class="stat-value" id="high-score-val">0</div>
                </div>
            </div>
            <div class="hud-group" style="align-items: flex-end;">
                <div class="stat-box">
                    <div class="stat-label" data-key="timer_label">Time Remaining</div>
                    <div class="stat-value" id="timer-val">60s</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label" data-key="multiplier_label">Power Multiplier</div>
                    <div class="stat-value" id="multiplier-val">x1.0</div>
                </div>
            </div>
        </div>

        <div id="achievement">WAVE 1</div>

        <div id="guardian" class="mode-heritage">
            <div class="guardian-label" id="guardian-mode-text" data-key="mode_heritage">Warisan</div>
        </div>

        <div id="fact-bubble">
            <span id="fact-text"
                style="font-size: 1.15rem; font-weight: 500; color: #fff; line-height: 1.5; display: block;"></span>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="overlay">
            <h1 data-key="title">Chronicles of Alam Melayu</h1>
            <p data-key="description">Protect the ancient heritage and spiritual wisdom of the Malay kingdoms. Align
                your guardian shield to catch the artifacts and preserve our historical identity.</p>
            <button class="btn" onclick="game.start()" data-key="start_btn">Begin Revelation</button>
            <div class="instructions">
                <p data-key="inst_1">ÔøΩÔ∏è <b>Move Mouse</b>: Control Guardian movement.</p>
                <p data-key="inst_2">üõ°Ô∏è <b>Left Click/Space</b>: Switch Shield Mode (Agama/Warisan).</p>
                <p data-key="inst_3">‚ú® <b>Match & Catch</b>: Catch items of the matching category for points!</p>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="overlay" style="display: none;">
            <h1 data-key="game_over">The Record is Sealed</h1>
            <div class="stars-container" id="stars-display">
                <span class="star">‚òÖ</span>
                <span class="star">‚òÖ</span>
                <span class="star">‚òÖ</span>
            </div>
            <div class="stat-box" style="margin-bottom: 30px; border-color: var(--primary-gold);">
                <div class="stat-label" data-key="final_score">Final Legacy Points</div>
                <div class="stat-value" id="final-score-val" style="font-size: 2.8rem; color: var(--primary-gold);">0
                </div>
            </div>
            <p id="evaluation-text" style="font-style: italic; margin-bottom: 35px;"></p>
            <button class="btn" onclick="game.restart()" data-key="restart_btn">Transcend History</button>
        </div>
    </div>

    <script>
        /**
         * Chronicles of Alam Melayu: Heritage Guardian
         * Final Sophisticated Implementation with Movement
         */

        const CONFIG = {
            GAME_DURATION: 60,
            INITIAL_SPAWN_RATE: 1500,
            MIN_SPAWN_RATE: 450,
            ITEM_SPEED_MIN: 2.8,
            ITEM_SPEED_MAX: 4.8,
            TYPES: {
                RELIGION: 'religion',
                HERITAGE: 'heritage',
                WISDOM: 'wisdom'
            }
        };

        const STRINGS = {
            en: {
                title: "Chronicles of Alam Melayu",
                description: "Master the legacy of the Great Kingdoms. Align your spiritual shield to the essence of falling artifacts. Do not let the wisdom of the past fade into chaos.",
                start_btn: "Begin Revelation",
                restart_btn: "Transcend History",
                score_label: "Score",
                high_score_label: "Top Record",
                timer_label: "Time Remaining",
                multiplier_label: "Power Multiplier",
                game_over: "The Record is Sealed",
                final_score: "Final Legacy Points",
                mode_heritage: "Heritage Mode",
                mode_religion: "Religion Mode",
                inst_1: "üñ±Ô∏è Move Mouse: Control Guardian movement across the screen.",
                inst_2: "üõ°Ô∏è Click/Space: Switch Shield Mode between Religion (Blue) & Heritage (Gold).",
                inst_3: "‚ö° Match & Catch: Catch items with the correct shield to build your multiplier!",
                eval_1: "A seeker of knowledge. The path of the ancestors is long.",
                eval_2: "Guardian of the Realms. Your wisdom shines bright.",
                eval_3: "Eternal Chronicler! You have mastered the spirit of the Orient!",
                wave_prefix: "WAVE ",
                facts: [
                    "Animism & Dinamisme were the core early beliefs of Alam Melayu.",
                    "Hinduism/Buddhism influenced the concept of 'Devaraja' (Divine King).",
                    "Islam arrived in the 7th century, bringing Jawi scripts and new laws.",
                    "Candi architecture like Borobudur & Angkor Wat are peak heritage sites.",
                    "Srivijaya was the spiritual center for Buddhist studies in SE Asia.",
                    "The Malay language was the 'Lingua Franca' for regional trade.",
                    "Baray irrigation in Angkor shows advanced engineering wisdom.",
                    "Diplomacy with China helped Melaka flourish as a trade hub.",
                    "Pallava, Kawi, and Jawi scripts preserve our written history.",
                    "Royal Regalia signifies the sovereignty of the Malay Monarchs.",
                    "The concept of 'Daulat' defines the sacred power of the King.",
                    "Kedah Tua was a major early center for iron smelting & trade.",
                    "Majapahit's influence spread far through the 'Sumpah Palapa'.",
                    "Candi Lembah Bujang is evidence of Hindu-Buddhist influence in Kedah.",
                    "Traditional medicine (Jamu/Ubat) is part of the unique heritage."
                ]
            },
            ms: {
                title: "Hikayat Alam Melayu",
                description: "Kuasai warisan Kerajaan-Kerajaan Agung. Selaraskan perisai rohani anda dengan pati artifak yang jatuh. Jangan biarkan kearifan masa lalu pudar dalam kekacauan.",
                start_btn: "Mulakan Wahyu",
                restart_btn: "Melangkaui Sejarah",
                score_label: "Skor",
                high_score_label: "Rekod Terbaik",
                timer_label: "Baki Masa",
                multiplier_label: "Pengganda Kuasa",
                game_over: "Rekod Telah Dimeterai",
                final_score: "Mata Warisan Akhir",
                mode_heritage: "Mod Warisan",
                mode_religion: "Mod Agama",
                inst_1: "üñ±Ô∏è Gerakkan Tetikus: Kawal pergerakan Penjaga di seluruh skrin.",
                inst_2: "üõ°Ô∏è Klik/Space: Tukar mod perisai antara Agama (Biru) & Warisan (Emas).",
                inst_3: "‚ö° Padan & Tangkap: Tangkap item dengan perisai yang betul untuk mata kombo!",
                eval_1: "Pencari ilmu. Jalan nenek moyang masih jauh.",
                eval_2: "Penjaga Alam. Kebijaksanaan anda terpancar terang.",
                eval_3: "Kronikel Abadi! Anda telah menguasai roh ketimuran!",
                wave_prefix: "GELOMBANG ",
                facts: [
                    "Animisme & Dinamisme adalah teras kepercayaan awal Alam Melayu.",
                    "Agama Hindu/Buddha mempengaruhi konsep 'Devaraja' (Raja Dewa).",
                    "Islam tiba pada abad ke-7, membawa tulisan Jawi dan hukum baharu.",
                    "Seni bina Candi seperti Borobudur & Angkor Wat adalah tapak warisan utama.",
                    "Srivijaya menjadi pusat pengajian agama Buddha di Asia Tenggara.",
                    "Bahasa Melayu merupakan 'Lingua Franca' bagi perdagangan serantau.",
                    "Sistem pengairan Baray di Angkor menunjukkan kearifan kejuruteraan.",
                    "Diplomasi dengan China membantu Melaka berkembang sebagai hab.",
                    "Tulisan Pallava, Kawi, dan Jawi memelihara sejarah bertulis kita.",
                    "Alat Kebesaran Diraja melambangkan kedaulatan Raja-raja Melayu.",
                    "Konsep 'Daulat' menentukan kuasa suci seorang Raja.",
                    "Kedah Tua merupakan pusat utama peleburan besi dan perdagangan.",
                    "Pengaruh Majapahit tersebar luas melalui 'Sumpah Palapa'.",
                    "Candi Lembah Bujang bukti pengaruh Hindu-Buddha di Kedah.",
                    "Perubatan tradisional (Jamu/Ubat) adalah sebahagian warisan unik."
                ]
            }
        };

        const ASSETS = {
            religion: [
                { icon: 'üïâÔ∏è', fact: 1, color: '#4fa4ff' },
                { icon: '‚ò∏Ô∏è', fact: 1, color: '#4fa4ff' },
                { icon: 'üåô', fact: 2, color: '#4fa4ff' },
                { icon: 'üåø', fact: 0, color: '#4fa4ff' },
                { icon: 'üóø', fact: 0, color: '#4fa4ff' },
                { icon: 'üïç', fact: 4, color: '#4fa4ff' }
            ],
            heritage: [
                { icon: 'üèõÔ∏è', fact: 3, color: '#ffd700' },
                { icon: 'üìú', fact: 8, color: '#ffd700' },
                { icon: 'üëë', fact: 9, color: '#ffd700' },
                { icon: 'üß±', fact: 6, color: '#ffd700' },
                { icon: '‚õµ', fact: 5, color: '#ffd700' },
                { icon: 'üó°Ô∏è', fact: 10, color: '#ffd700' },
                { icon: 'üè∫', fact: 11, color: '#ffd700' }
            ],
            wisdom: [
                { icon: 'ü§ù', fact: 7, color: '#4ade80' },
                { icon: 'üèóÔ∏è', fact: 6, color: '#4ade80' },
                { icon: 'üíä', fact: 14, color: '#4ade80' }
            ]
        };

        class Game {
            constructor() {
                this.lang = 'ms';
                this.score = 0;
                this.highScore = localStorage.getItem('alamMelayuHighScore') || 0;
                this.isPlaying = false;
                this.timeLeft = CONFIG.GAME_DURATION;
                this.multiplier = 1.0;
                this.combo = 0;
                this.mode = 'heritage';
                this.items = [];
                this.particles = [];
                this.bgParticles = [];
                this.wave = 1;
                this.spawnRate = CONFIG.INITIAL_SPAWN_RATE;

                // Movement state
                this.guardianX = window.innerWidth / 2;
                this.targetX = this.guardianX;
                this.guardianWidth = 140;

                this.canvasBg = document.getElementById('bg-canvas');
                this.canvasItems = document.getElementById('item-canvas');
                this.canvasParts = document.getElementById('particle-canvas');

                this.ctxBg = this.canvasBg.getContext('2d');
                this.ctxItems = this.canvasItems.getContext('2d');
                this.ctxParts = this.canvasParts.getContext('2d');

                this.init();
            }

            init() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.initBgParticles();
                this.updateStrings();
                document.getElementById('high-score-val').innerText = this.highScore;

                // Input Listeners
                window.addEventListener('mousemove', (e) => {
                    this.targetX = e.clientX;
                });

                window.addEventListener('touchmove', (e) => {
                    if (e.touches[0]) this.targetX = e.touches[0].clientX;
                }, { passive: false });

                window.addEventListener('mousedown', () => {
                    if (this.isPlaying) this.switchMode();
                });

                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        this.switchMode();
                    }
                });

                this.animate();
            }

            resize() {
                this.canvasBg.width = this.canvasItems.width = this.canvasParts.width = window.innerWidth;
                this.canvasBg.height = this.canvasItems.height = this.canvasParts.height = window.innerHeight;
                this.guardianWidth = window.innerWidth < 768 ? 100 : 140;
            }

            initBgParticles() {
                this.bgParticles = [];
                for (let i = 0; i < 80; i++) {
                    this.bgParticles.push({
                        x: Math.random() * innerWidth,
                        y: Math.random() * innerHeight,
                        size: Math.random() * 3 + 0.5,
                        speed: Math.random() * 0.5 + 0.1,
                        opacity: Math.random(),
                        osc: Math.random() * Math.PI
                    });
                }
            }

            updateStrings() {
                const t = STRINGS[this.lang];
                document.querySelectorAll('[data-key]').forEach(el => {
                    const key = el.getAttribute('data-key');
                    if (t[key]) el.innerText = t[key];
                });
                this.updateGuardianLabel();
            }

            toggleLanguage() {
                this.lang = this.lang === 'en' ? 'ms' : 'en';
                document.getElementById('lang-btn').innerText = this.lang === 'en' ? 'MS | EN' : 'EN | MS';
                this.updateStrings();
            }

            switchMode() {
                if (!this.isPlaying) return;
                this.mode = this.mode === 'heritage' ? 'religion' : 'heritage';
                const g = document.getElementById('guardian');
                g.className = `mode-${this.mode}`;
                this.updateGuardianLabel();

                const color = this.mode === 'religion' ? '#4fa4ff' : '#ffd700';
                this.createExplosion(this.guardianX, innerHeight - 190, color, 25);

                g.style.transition = 'none';
                g.style.transform = `scale(1.2)`;
                setTimeout(() => {
                    g.style.transition = 'border-color 0.3s ease, background 0.3s ease';
                    g.style.transform = `scale(1)`;
                }, 100);
            }

            updateGuardianLabel() {
                const key = this.mode === 'heritage' ? 'mode_heritage' : 'mode_religion';
                document.getElementById('guardian-mode-text').innerText = STRINGS[this.lang][key];
            }

            start() {
                this.isPlaying = true;
                this.score = 0;
                this.timeLeft = CONFIG.GAME_DURATION;
                this.multiplier = 1.0;
                this.combo = 0;
                this.wave = 1;
                this.items = [];
                this.spawnRate = CONFIG.INITIAL_SPAWN_RATE;
                this.guardianX = innerWidth / 2;
                this.targetX = innerWidth / 2;

                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('game-over-screen').style.display = 'none';
                document.getElementById('game-container').style.cursor = 'none';
                this.updateHUD();

                this.startTimers();
                this.showAchievement(STRINGS[this.lang].wave_prefix + "1");
            }

            startTimers() {
                if (this.gameInterval) clearInterval(this.gameInterval);
                if (this.spawnTimeout) clearTimeout(this.spawnTimeout);

                this.gameInterval = setInterval(() => {
                    if (!this.isPlaying) return;
                    this.timeLeft--;

                    if (this.timeLeft <= 0) {
                        this.timeLeft = 0;
                        this.updateHUD();
                        this.gameOver();
                        return;
                    }

                    this.updateHUD();

                    if (this.timeLeft % 12 === 0) {
                        this.wave++;
                        this.spawnRate = Math.max(CONFIG.MIN_SPAWN_RATE, this.spawnRate * 0.8);
                        this.showAchievement(STRINGS[this.lang].wave_prefix + this.wave);
                    }
                }, 1000);

                const loop = () => {
                    if (!this.isPlaying) return;
                    this.spawnItem();
                    this.spawnTimeout = setTimeout(loop, this.spawnRate);
                };
                loop();
            }

            spawnItem() {
                const rand = Math.random();
                let type;
                if (rand < 0.45) type = 'religion';
                else if (rand < 0.9) type = 'heritage';
                else type = 'wisdom';

                const pool = ASSETS[type];
                const item = pool[Math.floor(Math.random() * pool.length)];

                const x = 50 + Math.random() * (innerWidth - 100);
                this.items.push({
                    x, y: -100,
                    type,
                    icon: item.icon,
                    fact: item.fact,
                    color: item.color,
                    speed: (CONFIG.ITEM_SPEED_MIN + Math.random() * (CONFIG.ITEM_SPEED_MAX - CONFIG.ITEM_SPEED_MIN)) * (1 + (this.wave - 1) * 0.15),
                    rot: 0,
                    rotSpeed: (Math.random() - 0.5) * 0.12
                });
            }

            updateHUD() {
                document.getElementById('score-val').innerText = Math.floor(this.score);
                document.getElementById('timer-val').innerText = `${this.timeLeft}s`;
                document.getElementById('multiplier-val').innerText = `x${this.multiplier.toFixed(1)}`;
            }

            showAchievement(msg) {
                const el = document.getElementById('achievement');
                el.innerText = msg;
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 2500);
            }

            showFact(index) {
                const bubble = document.getElementById('fact-bubble');
                const text = document.getElementById('fact-text');
                text.innerText = STRINGS[this.lang].facts[index];
                bubble.classList.add('visible');
                setTimeout(() => bubble.classList.remove('visible'), 4500);
            }

            createExplosion(x, y, color, count) {
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x, y,
                        vx: (Math.random() - 0.5) * 12,
                        vy: (Math.random() - 0.5) * 12,
                        life: 1.0,
                        color,
                        size: Math.random() * 5 + 2
                    });
                }
            }

            spawnPointsText(x, y, text, color) {
                const div = document.createElement('div');
                div.className = 'points-anim';
                div.innerText = text;
                div.style.left = `${x}px`;
                div.style.top = `${y}px`;
                div.style.color = color;
                document.getElementById('game-container').appendChild(div);
                setTimeout(() => div.remove(), 1200);
            }

            gameOver() {
                this.isPlaying = false;
                clearInterval(this.gameInterval);
                clearTimeout(this.spawnTimeout);

                document.getElementById('game-container').style.cursor = 'auto';

                if (this.score > this.highScore) {
                    this.highScore = Math.floor(this.score);
                    localStorage.setItem('alamMelayuHighScore', this.highScore);
                    document.getElementById('high-score-val').innerText = this.highScore;
                }

                document.getElementById('final-score-val').innerText = Math.floor(this.score);
                document.getElementById('game-over-screen').style.display = 'flex';

                let stars = 0;
                if (this.score >= 500) stars = 1;
                if (this.score >= 1200) stars = 2;
                if (this.score >= 2500) stars = 3;

                const nodes = document.getElementById('stars-display').children;
                for (let i = 0; i < 3; i++) nodes[i].classList.toggle('active', i < stars);

                document.getElementById('evaluation-text').innerText = STRINGS[this.lang][`eval_${stars || 1}`];
            }

            restart() {
                this.start();
            }

            animate() {
                // Smooth movement interpolation (Lerp)
                const lerpFactor = 0.15;
                this.guardianX += (this.targetX - this.guardianX) * lerpFactor;

                // Clamp guardian within screen
                const halfWidth = this.guardianWidth / 2;
                if (this.guardianX < halfWidth) this.guardianX = halfWidth;
                if (this.guardianX > innerWidth - halfWidth) this.guardianX = innerWidth - halfWidth;

                // Update Guardian DOM position
                const gEl = document.getElementById('guardian');
                gEl.style.left = `${this.guardianX - halfWidth}px`;

                // Background Rendering
                this.ctxBg.clearRect(0, 0, innerWidth, innerHeight);

                // Ancient Geometric Background
                this.ctxBg.strokeStyle = 'rgba(255, 215, 0, 0.04)';
                this.ctxBg.lineWidth = 1;
                const time = Date.now() * 0.001;
                for (let i = 0; i < 3; i++) {
                    this.ctxBg.beginPath();
                    this.ctxBg.arc(innerWidth / 2, innerHeight / 2, 200 + i * 80 + Math.sin(time + i) * 20, 0, Math.PI * 2);
                    this.ctxBg.stroke();
                }

                this.bgParticles.forEach(p => {
                    p.y += p.speed;
                    p.osc += 0.02;
                    const xOffset = Math.sin(p.osc) * 5;
                    if (p.y > innerHeight) p.y = -20;
                    this.ctxBg.fillStyle = `rgba(255, 255, 255, ${p.opacity * (0.5 + Math.sin(time + p.osc) * 0.5)})`;
                    this.ctxBg.beginPath();
                    this.ctxBg.arc(p.x + xOffset, p.y, p.size, 0, Math.PI * 2);
                    this.ctxBg.fill();
                });

                // Items Handling
                this.ctxItems.clearRect(0, 0, innerWidth, innerHeight);
                const gY = innerHeight - 120 - (this.guardianWidth / 2);

                if (this.isPlaying) {
                    for (let i = this.items.length - 1; i >= 0; i--) {
                        const item = this.items[i];
                        item.y += item.speed;
                        item.rot += item.rotSpeed;

                        // Draw Item with Shadow Glow
                        this.ctxItems.save();
                        this.ctxItems.translate(item.x, item.y);
                        this.ctxItems.rotate(item.rot);
                        this.ctxItems.font = `${innerWidth < 768 ? '45px' : '60px'} Outfit`;
                        this.ctxItems.textAlign = 'center';
                        this.ctxItems.textBaseline = 'middle';
                        this.ctxItems.shadowBlur = 20;
                        this.ctxItems.shadowColor = item.color;
                        this.ctxItems.fillText(item.icon, 0, 0);
                        this.ctxItems.restore();

                        // Collision Logic (Circular)
                        const dx = item.x - this.guardianX;
                        const dy = item.y - (innerHeight - 120 - halfWidth);
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        if (dist < halfWidth + 20) {
                            this.handleCollection(item, i);
                        } else if (item.y > innerHeight + 100) {
                            this.items.splice(i, 1);
                            if (item.type !== 'wisdom') {
                                this.combo = 0;
                                this.multiplier = 1.0;
                            }
                        }
                    }
                }

                // Particles
                this.ctxParts.clearRect(0, 0, innerWidth, innerHeight);
                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life -= 0.025;
                    if (p.life <= 0) {
                        this.particles.splice(i, 1);
                    } else {
                        this.ctxParts.globalAlpha = p.life;
                        this.ctxParts.fillStyle = p.color;
                        this.ctxParts.beginPath();
                        this.ctxParts.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
                        this.ctxParts.fill();
                    }
                }

                requestAnimationFrame(() => this.animate());
            }

            handleCollection(item, index) {
                let isCorrect = (item.type === this.mode);
                let bonus = (item.type === 'wisdom');

                if (isCorrect || bonus) {
                    this.combo++;
                    this.multiplier = Math.min(5, 1 + (Math.floor(this.combo / 4) * 0.25));
                    const basePoints = bonus ? 60 : 25;
                    const gained = basePoints * this.multiplier;
                    this.score += gained;

                    this.createExplosion(item.x, item.y, item.color, 30);
                    this.spawnPointsText(item.x, item.y, `+${Math.floor(gained)}`, item.color);

                    if (Math.random() > 0.7 || bonus) {
                        this.showFact(item.fact);
                    }
                } else {
                    this.combo = 0;
                    this.multiplier = 1.0;
                    this.createExplosion(item.x, item.y, '#ff4d4d', 20);
                    this.spawnPointsText(item.x, item.y, 'MISS', '#ff4d4d');
                    // Flash screen red briefly
                    const container = document.getElementById('game-container');
                    container.style.boxShadow = 'inset 0 0 100px rgba(255,0,0,0.3)';
                    setTimeout(() => container.style.boxShadow = 'none', 100);
                }

                this.updateHUD();
                this.items.splice(index, 1);
            }
        }

        const game = new Game();
    </script>
</body>

</html>